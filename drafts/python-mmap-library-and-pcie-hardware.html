<!DOCTYPE html>
<html lang="en">
<head>
        <title>Python mmap library and PCIe hardware</title>
        <meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="shortcut icon" href="../theme/images/favicon.ico"/>
        <link rel="stylesheet" href="../theme/css/main.css" type="text/css" />
        <link href="www.j-marjanovic.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="j-marjanovic.io Atom Feed" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="../css/ie.css"/>
                <script src="../js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="../css/ie6.css"/><![endif]-->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js" type="text/javascript"></script>
<script type="text/javascript" src="theme/jquery.cookiesdirective.js"></script>

</head>

<body id="index" class="home">
<script type="text/javascript">
	// Using $(document).ready never hurts
	$(document).ready(function(){

		// Cookie setting script wrapper
		var cookieScripts = function () {
			// Internal javascript called
			console.log("Running");
		
			// Loading external javascript file
			$.cookiesDirective.loadScript({
				uri:'external.js',
				appendTo: 'eantics'
			});
		}
	
		/* Call cookiesDirective, overriding any default params
		
			*** These are the defaults ***
				explicitConsent: true,
				position: 'top',
				duration: 10,
				limit: 0,
				message: null,				
				cookieScripts: null,
				privacyPolicyUri: 'privacy.html',
				scriptWrapper: function(){},	
				fontFamily: 'helvetica',
				fontColor: '#FFFFFF',
				fontSize: '13px',
				backgroundColor: '#000000',
				backgroundOpacity: '80',
				linkColor: '#CA0000'
				
		*/
		
		$.cookiesDirective({
			privacyPolicyUri: 'myprivacypolicy.html',
			explicitConsent: false,
			position : 'bottom',
			scriptWrapper: cookieScripts, 
			cookieScripts: 'Google Analytics', 
			backgroundColor: '#52B54A',
			linkColor: '#ffffff'
		});
	});
</script>

	
  <!-- <header id="banner" class="body"> -->
  <!--               <h1><a href="../"><img src="http://www.launchyard.com/images/logo.png" /></a></h1> -->
  <!--       </header> --> 

  <div class="LaunchyardDetail" style="align:right;">
    <!-- <p> -->
    <!-- <img src="../theme/images/blue-pin.png" width="100" height="100" alt="Graph icon"> -->
    <!-- </p> -->
    <p><a id="sitesubtitle" href="../">j-marjanovic.io</a></p>

	<br>
    <p style="float: right; margin-right: 50px;"><a id="aboutlink" href="../pages/about.html">About</a></p>

    <br>
	<p style="float: right; margin-right: 50px;"><img src="../theme/images/icons/rss.png"> <a id="aboutlink" href="../feeds/jan-marjanovic.atom.xml">Atom feed</a></p>
    <br>

  </div>

<section id="content" >
    <div class="body">
      <article>
        <header>
          <h1 class="entry-title">
            <a href="../drafts/python-mmap-library-and-pcie-hardware.html" rel="bookmark"
               title="Permalink to Python mmap library and PCIe hardware">Python mmap library and PCIe hardware</a></h1>

        </header>

        <div class="entry-content">
<div class="post-info">
	<ul>
        <li class="vcard author">
                 by&nbsp;<a class="url fn" href="../author/jan-marjanovic.html">Jan Marjanovic</a>
        </li>
        <li class="published" title="2021-10-25T20:00:00+02:00">
          on&nbsp;Mon 25 October 2021
        </li>

	</ul>

</div><!-- /.post-info -->          <p>While developing an app, ...</p>
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>./pp_sp_test --dev /dev/pp_sp_pcie_0000:05:00.0 --write --read
<span class="go">Arguments:</span>
<span class="go">  dev = /dev/pp_sp_pcie_0000:05:00.0</span>
<span class="go">  c2h = 1, h2c = 1</span>
<span class="go">  nr_bytes = 256, count = 1</span>
<span class="go">===================================</span>
<span class="go">[loop] i = 0</span>
<span class="go">[gen] id reg = a51579e2</span>
<span class="go">[gen] state = 1</span>
<span class="go">[gen] nr samp = 16</span>
<span class="go">[c2h] DMA duration 0.096867 ms</span>
<span class="go">[c2h] ioctl took 0.026000 ms</span>
<span class="go">[gen] state = 0</span>
<span class="go">[gen] nr samp = 256</span>
<span class="go">[check] id reg = a5157c8c</span>
<span class="go">[h2c] DMA duration 0.065122 ms</span>
<span class="go">[h2c] ioctl took 0.015000 ms</span>
<span class="go">[check] samp = 256 / 256</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>$ ./pp_sp_test.py
<span class="nv">duration</span> <span class="o">=</span> <span class="m">92</span>.84 us
  <span class="m">0</span>   <span class="m">1</span>   <span class="m">2</span>   <span class="m">3</span> 
  <span class="m">4</span>   <span class="m">5</span>   <span class="m">6</span>   <span class="m">7</span> 
  <span class="m">0</span>   <span class="m">1</span>   <span class="m">2</span>   <span class="m">3</span> 
  <span class="m">4</span>   <span class="m">5</span>   <span class="m">6</span>   <span class="m">7</span> 
  <span class="m">8</span>   <span class="m">9</span>   a   b 
  c   d   e   f 
 <span class="m">10</span>  <span class="m">11</span>  <span class="m">12</span>  <span class="m">13</span> 
 <span class="m">14</span>  <span class="m">15</span>  <span class="m">16</span>  <span class="m">17</span> 
</code></pre></div>

<p>image: two writes</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nr_samp</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wr32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ADDR_SAMPLES</span><span class="p">,</span> <span class="n">nr_samp</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">pdb</span><span class="p">;</span> <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wr32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ADDR_CTRL</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div>

<p>$ ./pp_sp_test.py
&lt;...&gt;
-&gt; self.mem[self.offs + addr : self.offs + addr + 4] = bs
(Pdb) step
--Return--</p>
<blockquote>
<p>/home/jan/pcie/driver/tui/HwModules.py(24)_wr32()-&gt;None
-&gt; self.mem[self.offs + addr : self.offs + addr + 4] = bs</p>
</blockquote>
<div class="highlight"><pre><span></span><code>CFLAGS=&#39;-g -O0&#39; ./configure
make -j 32
</code></pre></div>

<p>gdbserver localhost:4444 ./python</p>
<p>https://sourceware.org/gdb/current/onlinedocs/gdb/Server.html</p>
<div class="highlight"><pre><span></span><code><span class="nt">Breakpoint</span> <span class="nt">3</span><span class="o">,</span> <span class="nt">mmap_ass_subscript</span> <span class="o">(</span><span class="nt">self</span><span class="o">=</span><span class="nt">0x0</span><span class="o">,</span> <span class="nt">item</span><span class="o">=</span><span class="nt">69664</span><span class="o">,</span> <span class="nt">value</span><span class="o">=&lt;</span><span class="nt">unknown</span> <span class="nt">at</span> <span class="nt">remote</span> <span class="nt">0x555555604c16</span><span class="o">&gt;)</span> <span class="nt">at</span> <span class="o">/</span><span class="nt">home</span><span class="o">/</span><span class="nt">jan</span><span class="o">/</span><span class="nt">cpython</span><span class="o">/</span><span class="nt">Modules</span><span class="o">/</span><span class="nt">mmapmodule</span><span class="p">.</span><span class="nc">c</span><span class="p">:</span><span class="nd">904</span>
<span class="o">&lt;...&gt;</span>
<span class="nt">969</span>         <span class="nt">else</span> <span class="nt">if</span> <span class="o">(</span><span class="nt">step</span> <span class="o">==</span> <span class="nt">1</span><span class="o">)</span> <span class="p">{</span>
<span class="err">(gdb)</span> <span class="err">n</span>
<span class="err">970</span>             <span class="err">memcpy(self-&gt;data</span> <span class="err">+</span> <span class="err">start,</span> <span class="err">vbuf.buf,</span> <span class="err">slicelen)</span><span class="p">;</span>
<span class="err">(gdb)</span> <span class="err">n</span>
<span class="err">983</span>         <span class="err">PyBuffer_Release(&amp;vbuf)</span><span class="p">;</span>
<span class="err">(gdb)</span> <span class="err">p</span> <span class="err">slicelen</span>
<span class="err">$2</span> <span class="err">=</span> <span class="err">4</span>
</code></pre></div>

<h2>Solution 1</h2>
<div class="highlight"><pre><span></span><code>From 7be0ae2c0bc50bced2d53a7706e8293a583d40b1 Mon Sep 17 00:00:00 2001
From: Jan Marjanovic &lt;jan.marjanovic@outlook.com&gt;
Date: Tue, 26 Oct 2021 20:38:41 +0200
Subject: [PATCH] mmap: replace memcpy with reg copy for some cases

<span class="gd">---</span>
 Modules/mmapmodule.c | 8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

<span class="gh">diff --git a/Modules/mmapmodule.c b/Modules/mmapmodule.c</span>
<span class="gh">index 18758861a6..53227d5c99 100644</span>
<span class="gd">--- a/Modules/mmapmodule.c</span>
<span class="gi">+++ b/Modules/mmapmodule.c</span>
<span class="gu">@@ -967,7 +967,13 @@ mmap_ass_subscript(mmap_object *self, PyObject *item, PyObject *value)</span>
         if (slicelen == 0) {
         }
         else if (step == 1) {
<span class="gd">-            memcpy(self-&gt;data + start, vbuf.buf, slicelen);</span>
<span class="gi">+            if (slicelen == 4) {</span>
<span class="gi">+                memcpy(self-&gt;data + start, vbuf.buf, 4);</span>
<span class="gi">+            } else if (slicelen == 8) {</span>
<span class="gi">+                memcpy(self-&gt;data + start, vbuf.buf, 8);</span>
<span class="gi">+            } else {</span>
<span class="gi">+                memcpy(self-&gt;data + start, vbuf.buf, slicelen);</span>
<span class="gi">+            }</span>
         }
         else {
             size_t cur;
<span class="gd">-- </span>
2.25.1
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="w"> </span><span class="n">jan</span><span class="nv">@anton1</span><span class="w"> </span><span class="err"></span><span class="w"> </span><span class="o">~/</span><span class="n">cpython</span><span class="w"> </span><span class="err"></span><span class="w"> </span><span class="err">➦</span><span class="w"> </span><span class="mi">3</span><span class="n">d8993a744</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="err"></span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">python</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">pcie</span><span class="o">/</span><span class="n">driver</span><span class="o">/</span><span class="n">tui</span><span class="o">/</span><span class="n">pp_sp_test</span><span class="p">.</span><span class="n">py</span><span class="w">   </span>
<span class="n">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">106.40</span><span class="w"> </span><span class="n">us</span><span class="w"></span>
<span class="w">  </span><span class="mi">0</span><span class="w">   </span><span class="mi">1</span><span class="w">   </span><span class="mi">2</span><span class="w">   </span><span class="mi">3</span><span class="w"> </span>
<span class="w">  </span><span class="mi">4</span><span class="w">   </span><span class="mi">5</span><span class="w">   </span><span class="mi">6</span><span class="w">   </span><span class="mi">7</span><span class="w"> </span>
<span class="w">  </span><span class="mi">8</span><span class="w">   </span><span class="mi">9</span><span class="w">   </span><span class="n">a</span><span class="w">   </span><span class="n">b</span><span class="w"> </span>
<span class="w">  </span><span class="n">c</span><span class="w">   </span><span class="n">d</span><span class="w">   </span><span class="n">e</span><span class="w">   </span><span class="n">f</span><span class="w"> </span>
<span class="w"> </span><span class="mi">10</span><span class="w">  </span><span class="mi">11</span><span class="w">  </span><span class="mi">12</span><span class="w">  </span><span class="mi">13</span><span class="w"> </span>
<span class="w"> </span><span class="mi">14</span><span class="w">  </span><span class="mi">15</span><span class="w">  </span><span class="mi">16</span><span class="w">  </span><span class="mi">17</span><span class="w"> </span>
<span class="w"> </span><span class="mi">18</span><span class="w">  </span><span class="mi">19</span><span class="w">  </span><span class="mi">1</span><span class="n">a</span><span class="w">  </span><span class="mi">1</span><span class="n">b</span><span class="w"> </span>
<span class="w"> </span><span class="mi">1</span><span class="n">c</span><span class="w">  </span><span class="mi">1</span><span class="n">d</span><span class="w">  </span><span class="mi">1</span><span class="n">e</span><span class="w">  </span><span class="mi">1</span><span class="n">f</span><span class="w"> </span>
</code></pre></div>

<h2>Solution 2</h2>
<div class="highlight"><pre><span></span><code>From 92452f3ea6e52a95f841efe127d4e728a6295013 Mon Sep 17 00:00:00 2001
From: Jan Marjanovic &lt;jan.marjanovic@outlook.com&gt;
Date: Tue, 26 Oct 2021 21:26:34 +0200
Subject: [PATCH] Avalon ST Generator: only accept start cmd in IDLE

<span class="gd">---</span>
 ip_cores/avalon_st_generator/hdl/avalon_st_generator.sv | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

<span class="gh">diff --git a/ip_cores/avalon_st_generator/hdl/avalon_st_generator.sv b/ip_cores/avalon_st_generator/hdl/avalon_st_generator.sv</span>
<span class="gh">index ede8493..02a2dd0 100644</span>
<span class="gd">--- a/ip_cores/avalon_st_generator/hdl/avalon_st_generator.sv</span>
<span class="gi">+++ b/ip_cores/avalon_st_generator/hdl/avalon_st_generator.sv</span>
<span class="gu">@@ -57,7 +57,7 @@ module avalon_st_generator #(</span>
   always_ff @(posedge clk) begin : proc_avs_ctrl_readdata
     case (avs_ctrl_address)
       0: avs_ctrl_readdata &lt;= 32&#39;ha51579e2;
<span class="gd">-      1: avs_ctrl_readdata &lt;= 32&#39;h00000200;</span>
<span class="gi">+      1: avs_ctrl_readdata &lt;= 32&#39;h00000300;</span>
       2: avs_ctrl_readdata &lt;= 32&#39;h00000000;
       3: avs_ctrl_readdata &lt;= reg_scratch;
       4: avs_ctrl_readdata &lt;= state;
<span class="gu">@@ -91,7 +91,7 @@ module avalon_st_generator #(</span>
   logic [DATA_W/SAMP_W-1:0][SAMP_W-1:0] ref_data;

   always_ff @(posedge clk) begin : proc_ref_data
<span class="gd">-    if (reg_ctrl_start || rsi_reset_reset) begin</span>
<span class="gi">+    if ((reg_ctrl_start &amp;&amp; !state) || rsi_reset_reset) begin</span>
       for (int i = 0; i &lt; DATA_W / SAMP_W; i++) begin
         ref_data[i] &lt;= i;
       end
<span class="gu">@@ -112,7 +112,7 @@ module avalon_st_generator #(</span>
   end

   always_ff @(posedge clk) begin : proc_cntr
<span class="gd">-    if (reg_ctrl_start || rsi_reset_reset) begin</span>
<span class="gi">+    if ((reg_ctrl_start &amp;&amp; !state) || rsi_reset_reset) begin</span>
       cntr_cur &lt;= 0;
     end else begin
       if (aso_data_valid &amp;&amp; aso_data_ready) begin
<span class="gd">-- </span>
2.32.0
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="go"> jan@anton1  driver/tui   main ±  python3 ./pp_sp_test.py                     </span>
<span class="go">duration = 98.94 us</span>
<span class="go">  0   1   2   3 </span>
<span class="go">  4   5   6   7 </span>
<span class="go">  8   9   a   b </span>
<span class="go">  c   d   e   f </span>
<span class="go"> 10  11  12  13 </span>
<span class="go"> 14  15  16  17 </span>
<span class="go"> 18  19  1a  1b </span>
<span class="go"> 1c  1d  1e  1f </span>
</code></pre></div><script src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
        </div><!-- /.entry-content -->
<a href="https://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="janmarjanovic">Tweet</a><script type="text/javascript" src="https://platform.twitter.com/widgets.js"></script><br/><br/>

      </article>
    </div>
</section>
        <section id="extras" >
        
        </section><!-- /#extras -->
	
        <footer id="contentinfo" >
                <address id="about" class="vcard ">
                Proudly powered by <a href="https://getpelican.com/" target="_blank">Pelican</a>, which takes
                great advantage of <a href="https://python.org" target="_blank">Python</a>.
		
                </address><!-- /#about -->
		

                
        </footer><!-- /#contentinfo -->

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-56555055-1', 'auto');
  ga('send', 'pageview');

</script></body>
</html>